eceived event "auth" from Ul7o00N5XeNhfv8wAAAD [/]
INFO:socketio.server:received event "auth" from Ul7o00N5XeNhfv8wAAAD [/]
Received 'auth' message from SID: Ul7o00N5XeNhfv8wAAAD. User ID provided: Yes
Reservation ID provided in auth: 3aa4e639-744e-4db3-ba2a-a71b4e021931
Phone number provided in auth: +15551234555
User already authenticated via connect: SID Ul7o00N5XeNhfv8wAAAD, User ID: temp_magic_
Stored system prompt in session (length: 17439)
System prompt starts with: You are Staycee, a helpful AI concierge assistant for "Scottsdale Retreat - Arizona Condo" located a...
Stored reservation ID in session: 3aa4e639-744e-4db3-ba2a-a71b4e021931
Stored phone number in session: +15551234555
emitting event "auth_success" to Ul7o00N5XeNhfv8wAAAD [/]
INFO:socketio.server:emitting event "auth_success" to Ul7o00N5XeNhfv8wAAAD [/]
aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["auth_success",{"message":"Authentication successful"}]
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["auth_success",{"message":"Authentication successful"}]
aZNwuySgJBwfnatBAAAC: Received packet MESSAGE data 2["text_message_from_user",{"message":"hello","property_id":"001eb55a-3def-41d1-85f5-e68f67d12ead"}]
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Received packet MESSAGE data 2["text_message_from_user",{"message":"hello","property_id":"001eb55a-3def-41d1-85f5-e68f67d12ead"}]
received event "text_message_from_user" from Ul7o00N5XeNhfv8wAAAD [/]
INFO:socketio.server:received event "text_message_from_user" from Ul7o00N5XeNhfv8wAAAD [/]
Received text message from SID: Ul7o00N5XeNhfv8wAAAD, User: temp_magic_: 'hello'
Property ID provided in message payload: 001eb55a-3def-41d1-85f5-e68f67d12ead
Using guest name from session: Aleksei
Using reservation ID from session: 3aa4e639-744e-4db3-ba2a-a71b4e021931
Extracted WiFi details - Network: dsdgfhjf, Password: fdfthjfg
Using system prompt from session (length: 17439)
Processing text query for property 001eb55a-3def-41d1-85f5-e68f67d12ead: 'hello'
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:39:20] "GET /favicon.ico?1757471960678 HTTP/1.1" 200 -
ERROR:concierge.utils.rate_limiter:Non-rate-limit error in Gemini API call: 400 INVALID_ARGUMENT. {'error': {'code': 400, 'message': 'Tool use with function calling is unsupported', 'status': 'INVALID_ARGUMENT'}}
ERROR:root:Error processing text query with tools: 400 INVALID_ARGUMENT. {'error': {'code': 400, 'message': 'Tool use with function calling is unsupported', 'status': 'INVALID_ARGUMENT'}}
Traceback (most recent call last):
  File "/Users/aborov/Workspace/concierge/concierge/utils/ai_helpers.py", line 774, in process_text_query_with_tools
    response = rate_limited_gemini_call(make_primary_call, max_retries=2)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/concierge/utils/rate_limiter.py", line 193, in rate_limited_gemini_call
    raise last_exception
  File "/Users/aborov/Workspace/concierge/concierge/utils/rate_limiter.py", line 168, in rate_limited_gemini_call
    result = func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/concierge/utils/ai_helpers.py", line 763, in make_primary_call
    return client.models.generate_content(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/google/genai/models.py", line 6112, in generate_content
    response = self._generate_content(
               ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/google/genai/models.py", line 4933, in _generate_content
    response = self._api_client.request(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/google/genai/_api_client.py", line 1262, in request
    response = self._request(http_request, http_options, stream=False)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/google/genai/_api_client.py", line 1082, in _request
    return self._retry(self._request_once, http_request, stream)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/tenacity/__init__.py", line 477, in __call__
    do = self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/tenacity/__init__.py", line 378, in iter
    result = action(retry_state)
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/tenacity/__init__.py", line 420, in exc_check
    raise retry_exc.reraise()
          ^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/tenacity/__init__.py", line 187, in reraise
    raise self.last_attempt.result()
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.11/3.11.13/Frameworks/Python.framework/Versions/3.11/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.11/3.11.13/Frameworks/Python.framework/Versions/3.11/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/tenacity/__init__.py", line 480, in __call__
    result = fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/google/genai/_api_client.py", line 1059, in _request_once
    errors.APIError.raise_for_response(response)
  File "/Users/aborov/Workspace/concierge/venv/lib/python3.11/site-packages/google/genai/errors.py", line 105, in raise_for_response
    raise ClientError(status_code, response_json, response)
google.genai.errors.ClientError: 400 INVALID_ARGUMENT. {'error': {'code': 400, 'message': 'Tool use with function calling is unsupported', 'status': 'INVALID_ARGUMENT'}}
Response generated without knowledge base context
Updated conversation history for SID Ul7o00N5XeNhfv8wAAAD, now has 2 messages
Using reservation ID for new conversation: 3aa4e639-744e-4db3-ba2a-a71b4e021931
Using phone number from session auth: +15551234555
Created new conversation session with ID: d439d125-d84b-4f8c-8b36-aa8545081d6e
emitting event "conversation_started" to Ul7o00N5XeNhfv8wAAAD [/]
INFO:socketio.server:emitting event "conversation_started" to Ul7o00N5XeNhfv8wAAAD [/]
aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["conversation_started",{"conversation_id":"d439d125-d84b-4f8c-8b36-aa8545081d6e","property_id":"001eb55a-3def-41d1-85f5-e68f67d12ead"}]
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["conversation_started",{"conversation_id":"d439d125-d84b-4f8c-8b36-aa8545081d6e","property_id":"001eb55a-3def-41d1-85f5-e68f67d12ead"}]
Added messages to conversation d439d125-d84b-4f8c-8b36-aa8545081d6e
Sending response to SID Ul7o00N5XeNhfv8wAAAD: I'm sorry, I'm having trouble accessing the information you need. How else can I assist you?
emitting event "text_message_from_ai" to Ul7o00N5XeNhfv8wAAAD [/]
INFO:socketio.server:emitting event "text_message_from_ai" to Ul7o00N5XeNhfv8wAAAD [/]
aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["text_message_from_ai",{"message":"I'm sorry, I'm having trouble accessing the information you need. How else can I assist you?"}]
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["text_message_from_ai",{"message":"I'm sorry, I'm having trouble accessing the information you need. How else can I assist you?"}]
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:39:27] "GET /favicon.ico?1757471967677 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:39:34] "GET /favicon.ico?1757471974678 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:39:41] "GET /favicon.ico?1757471981678 HTTP/1.1" 200 -
aZNwuySgJBwfnatBAAAC: Sending packet PING data None
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet PING data None
aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:39:48] "GET /favicon.ico?1757471988678 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:39:55] "GET /favicon.ico?1757471995678 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:02] "GET /favicon.ico?1757472002678 HTTP/1.1" 200 -
aZNwuySgJBwfnatBAAAC: Sending packet PING data None
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet PING data None
aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:09] "GET /favicon.ico?1757472009678 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:16] "GET /favicon.ico?1757472016679 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:23] "GET /favicon.ico?1757472023679 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:30] "GET /favicon.ico?1757472030679 HTTP/1.1" 200 -
aZNwuySgJBwfnatBAAAC: Sending packet PING data None
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet PING data None
aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:37] "GET /favicon.ico?1757472037678 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:44] "GET /favicon.ico?1757472044679 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:51] "GET /favicon.ico?1757472051679 HTTP/1.1" 200 -
aZNwuySgJBwfnatBAAAC: Sending packet PING data None
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet PING data None
aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Received packet PONG data 
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:40:58] "GET /favicon.ico?1757472058677 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:41:06] "GET /favicon.ico?1757472066407 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:41:13] "GET /favicon.ico?1757472073407 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [09/Sep/2025 21:41:20] "GET /favicon.ico?1757472080407 HTTP/1.1" 200 -
aZNwuySgJBwfnatBAAAC: Received packet MESSAGE data 2["user_disconnect",{"reason":"Inactivity timeout","timestamp":1757472081407,"inactivity_duration_ms":120000}]
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Received packet MESSAGE data 2["user_disconnect",{"reason":"Inactivity timeout","timestamp":1757472081407,"inactivity_duration_ms":120000}]
received event "user_disconnect" from Ul7o00N5XeNhfv8wAAAD [/]
INFO:socketio.server:received event "user_disconnect" from Ul7o00N5XeNhfv8wAAAD [/]
Received user_disconnect event from SID Ul7o00N5XeNhfv8wAAAD
  - Reason: Inactivity timeout
  - Timestamp: 1757472081407
  - Inactivity duration: 120000ms
emitting event "disconnect_acknowledged" to Ul7o00N5XeNhfv8wAAAD [/]
INFO:socketio.server:emitting event "disconnect_acknowledged" to Ul7o00N5XeNhfv8wAAAD [/]
aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["disconnect_acknowledged",{"message":"Disconnect event received","reason":"Inactivity timeout"}]
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Sending packet MESSAGE data 2["disconnect_acknowledged",{"message":"Disconnect event received","reason":"Inactivity timeout"}]
Finalized conversation d439d125-d84b-4f8c-8b36-aa8545081d6e as completed (inactivity timeout)
aZNwuySgJBwfnatBAAAC: Received packet MESSAGE data 1
INFO:engineio.server:aZNwuySgJBwfnatBAAAC: Received packet MESSAGE data 1
Client disconnected: SID Ul7o00N5XeNhfv8wAAAD
Cleaned up conversation history for SID Ul7o00N5XeNhfv8wAAAD (2 messages)
Disconnected session had conversation ID: d439d125-d84b-4f8c-8b36-aa8545081d6e